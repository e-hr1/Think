name: Auto Delete Old Images

on:
  schedule:
    - cron: '*/5 * * * *'  # ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
  workflow_dispatch:        # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø³Ø¬Ù„ git Ø§Ù„ÙƒØ§Ù…Ù„
          token: ${{ secrets.CLEANUP_TOKEN }}

      # ğŸ§¹ Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± commit
      - name: Remove old images based on git history
        run: |
          echo "ğŸ“ Checking image ages based on git log..."

          current_time=$(date +%s)
          threshold_minutes=5
          threshold_seconds=$((threshold_minutes * 60))

          for file in $(find images/ -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \)); do
            last_commit_time=$(git log -1 --format="%ct" -- "$file")
            if [ -z "$last_commit_time" ]; then
              echo "âš ï¸ No commit found for $file, skipping..."
              continue
            fi

            age=$((current_time - last_commit_time))

            if [ "$age" -gt "$threshold_seconds" ]; then
              echo "ğŸ—‘ï¸ Deleting $file (Age: $((age / 60)) minutes)"
              rm "$file"
            else
              echo "â³ Keeping $file (Age: $((age / 60)) minutes)"
            fi
          done

          echo "âœ… Cleanup complete."

      # ğŸ’¾ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¥Ù† ÙˆÙØ¬Ø¯Øª
      - name: Commit changes
        if: success()
        run: |
          git config user.name "GitHub Cleanup Bot"
          git config user.email "actions@github.com"
          git add images/
          git diff --quiet || (git commit -m "ğŸ”„ Auto-delete: Removed old images" && git push)
