name: Auto Delete Old Images

on:
  schedule:
    - cron: '*/5 * * * *'  # كل 5 دقائق
  workflow_dispatch:        # لتشغيل يدويًا من واجهة GitHub

jobs:
  cleanup:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.CLEANUP_TOKEN }}  # تأكد أن هذا التوكن له صلاحيات الكتابة على المستودع

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: 📁 Checking image ages based on git log and deleting old ones
        run: |
          echo "📁 Checking image ages based on git log..."
          deleted_any=false
          
          for file in images/*.{jpg,jpeg,png}; do
            [ -e "$file" ] || continue  # تخطى إذا لم يكن هناك ملفات
            last_commit_date=$(git log -1 --format="%ct" -- "$file" || echo 0)
            now=$(date +%s)
            age_minutes=$(( (now - last_commit_date) / 60 ))

            if [ "$age_minutes" -gt 5 ]; then
              echo "🗑️ Deleting $file (Age: $age_minutes minutes)"
              git rm "$file"
              deleted_any=true
            fi
          done

          if [ "$deleted_any" = true ]; then
            git config user.name "GitHub Cleanup Bot"
            git config user.email "bot@example.com"
            git commit -m "🧹 حذف الصور القديمة تلقائيًا"
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "✅ No old images found to delete."
          fi
