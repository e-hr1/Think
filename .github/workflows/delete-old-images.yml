name: Auto Delete Old Images

on:
  schedule:
    - cron: '*/5 * * * *'  # ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
  workflow_dispatch:        # Ù„ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© GitHub

jobs:
  cleanup:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.CLEANUP_TOKEN }}  # ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ“ Checking image ages based on git log and deleting old ones
        run: |
          echo "ğŸ“ Checking image ages based on git log..."
          deleted_any=false
          
          for file in images/*.{jpg,jpeg,png}; do
            [ -e "$file" ] || continue  # ØªØ®Ø·Ù‰ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ù„ÙØ§Øª
            last_commit_date=$(git log -1 --format="%ct" -- "$file" || echo 0)
            now=$(date +%s)
            age_minutes=$(( (now - last_commit_date) / 60 ))

            if [ "$age_minutes" -gt 5 ]; then
              echo "ğŸ—‘ï¸ Deleting $file (Age: $age_minutes minutes)"
              git rm "$file"
              deleted_any=true
            fi
          done

          if [ "$deleted_any" = true ]; then
            git config user.name "GitHub Cleanup Bot"
            git config user.email "bot@example.com"
            git commit -m "ğŸ§¹ Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§"
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "âœ… No old images found to delete."
          fi
