name: Auto Delete Old Images

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.CLEANUP_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Delete old images (based on file mod time)
        run: |
          echo "🔍 Checking images by file modified time..."
          deleted_any=false

          for file in images/*.{jpg,jpeg,png}; do
            [ -e "$file" ] || continue
            mod_time=$(date -r "$file" +%s)
            now=$(date +%s)
            age_minutes=$(( (now - mod_time) / 60 ))

            if [ "$age_minutes" -gt 5 ]; then
              echo "🗑️ Deleting $file (Age: $age_minutes min)"
              rm "$file"
              git rm "$file"
              deleted_any=true
            fi
          done

          if [ "$deleted_any" = true ]; then
            git config user.name "GitHub Cleanup Bot"
            git config user.email "bot@example.com"
            git commit -m "🧹 حذف الصور القديمة تلقائيًا"
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "✅ No old images found to delete."
          fi
