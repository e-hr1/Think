<!DOCTYPE html>

        function displayConversation(conversation) {
            const chatTitle = document.getElementById('chat-title');
            const chatBody = document.getElementById('chat-body');
            chatTitle.textContent = conversation.title || 'محادثة';
            chatBody.innerHTML = '';

            if (!conversation.messages || conversation.messages.length === 0) {
                const errorMessage = "المحادثة فارغة أو تم حذفها.";
                window.location.href = `welcome.html?toast=${encodeURIComponent(errorMessage)}`;
                return;
            }

            const username = "e-hr1";
            const repo = "Think";
            const branch = "main";

            function getIconUrl(fileType) {
                const iconMap = {
                    'pdf': 'icon_file_pdf.png', 'word': 'icon_word.png', 'excel': 'icon_exel.png',
                    'pptx': 'icon_pptx.png', 'txt': 'icon_txt.png', 'code': 'icon_file_code.png'
                };
                const iconName = iconMap[fileType] || 'icon_file_code.png';
                return `https://raw.githubusercontent.com/${username}/${repo}/${branch}/public/assets/icons/${iconName}`;
            }

            conversation.messages.forEach(msg => {
                // تجاهل الرسائل الفارغة تمامًا
                if (!msg.text && (!msg.imageUrls || msg.imageUrls.length === 0) && (!msg.attachedFiles || msg.attachedFiles.length === 0)) {
                    return;
                }

                const messageEl = document.createElement('div');
                messageEl.className = `message ${msg.isUser ? 'user' : 'bot'}`;

                const wrapperEl = document.createElement('div');
                wrapperEl.className = 'message-wrapper';

                const attachmentsEl = document.createElement('div');
                attachmentsEl.className = 'attachments-container';

                // عرض الصور
                if (msg.imageUrls && msg.imageUrls.length > 0) {
                    const imagesContainer = document.createElement('div');
                    imagesContainer.className = 'message-images';
                    if (msg.isUser) { imagesContainer.style.justifyContent = 'flex-end'; }
                    msg.imageUrls.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = 'صورة مرفقة';
                        img.onclick = () => window.open(url, '_blank');
                        imagesContainer.appendChild(img);
                    });
                    attachmentsEl.appendChild(imagesContainer);
                }

                // عرض الملفات
                if (msg.attachedFiles && msg.attachedFiles.length > 0) {
                    msg.attachedFiles.forEach(file => {
                        const fileDiv = document.createElement('div');
                        fileDiv.className = 'file-attachment';
                        fileDiv.innerHTML = `
                            <img src="${getIconUrl(file.type)}" alt="${file.type} icon">
                            <div class="file-info">
                                <div class="name">${file.name}</div>
                                <div class="size">${file.size}</div>
                            </div>`;
                        attachmentsEl.appendChild(fileDiv);
                    });
                }
                
                // إضافة المرفقات قبل النص للمستخدم، وبعده للبوت (للمحاكاة)
                if (msg.isUser) {
                    wrapperEl.appendChild(attachmentsEl);
                }

                // عرض النص
                if (msg.text && msg.text.trim() !== '') {
                    const bubbleEl = document.createElement('div');
                    bubbleEl.className = 'bubble';
                    // استخدام مكتبة marked لتحويل النص
                    bubbleEl.innerHTML = marked.parse(msg.text);
                    wrapperEl.appendChild(bubbleEl);
                }
                
                if (!msg.isUser) {
                     wrapperEl.appendChild(attachmentsEl);
                }

                // عرض الوقت
                const timestampEl = document.createElement('div');
                timestampEl.className = 'timestamp';
                timestampEl.textContent = new Date(msg.timestamp).toLocaleString('ar-SA', { hour: 'numeric', minute: 'numeric', hour12: true });
                wrapperEl.appendChild(timestampEl);

                messageEl.appendChild(wrapperEl);
                chatBody.appendChild(messageEl);
            });
        }
    </script>
</body>
</html>
