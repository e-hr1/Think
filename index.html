<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>عرض المحادثة</title>
    <!-- جلب مكتبة Marked لتحويل Markdown إلى HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* --- الوضع الفاتح (Light Mode) --- */
            --bg-color: #FFFFFF; /* scaffoldBackgroundColor */
            --text-color: #000000; /* bodyLarge color */
            --container-bg: #FFFFFF;
            --header-bg: #FFFFFF; /* appBarTheme background */
            --header-border: #e0e0e0;
            --bot-bubble-bg: #F8F8F8; /* cardColor */
            --user-bubble-bg: #ECF2FE; /* Color(0xFFECF2FE) */
            --user-bubble-text: #000000;
            --timestamp-color: #65676b;
            --attachment-border: #e0e0e0;
            --welcome-icon-filter: none;
        }

        .dark-mode {
            /* --- الوضع الداكن (Dark Mode) --- */
            --bg-color: #121212; /* scaffoldBackgroundColor */
            --text-color: #FFFFFF; /* bodyLarge color */
            --container-bg: #121212;
            --header-bg: #121212; /* appBarTheme background */
            --header-border: #3a3b3c;
            --bot-bubble-bg: #1E1E1E; /* cardColor */
            --user-bubble-bg: #2A3C5C; /* Color(0xFF2A3C5C) */
            --user-bubble-text: #FFFFFF;
            --timestamp-color: #b0b3b8;
            --attachment-border: #444;
            --welcome-icon-filter: brightness(0) invert(1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0; /* إزالة الحشوة من الجسم */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .chat-container {
            width: 100%;
            max-width: 800px; /* يمكنك تعديل العرض الأقصى */
            background-color: var(--container-bg);
            display: flex;
            flex-direction: column;
            height: 100vh; /* جعل الحاوية تملأ الشاشة عمودياً */
            box-sizing: border-box;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--header-border);
            background-color: var(--header-bg);
            text-align: center;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .chat-header h1 {
            margin: 0;
            font-size: 15px; /* مطابق لحجم الخط في AppBar */
            font-weight: bold; /* مطابق للتطبيق */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-body {
            flex-grow: 1;
            padding: 8px; /* مطابقة للمسافة في التطبيق */
            overflow-y: auto;
        }

        .message {
            display: flex;
            margin-bottom: 2px; /* vertical: 2 في التطبيق */
            max-width: 80%; /* maxWidth: 0.80 للمستخدم */
        }
        
        .message.bot {
             max-width: 100%; /* maxWidth: 1 للبوت */
        }

        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message.bot {
            margin-right: auto;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
        }

        .message.user .message-wrapper {
            align-items: flex-end;
        }

        .message.bot .message-wrapper {
            align-items: flex-start;
        }
        
        .bubble {
            padding: 12px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 16px; /* حجم الخط الأساسي للرسائل */
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user .bubble {
            background-color: var(--user-bubble-bg);
            color: var(--user-bubble-text);
        }

        .message.bot .bubble {
            background-color: var(--bot-bubble-bg);
            color: var(--text-color);
        }
        
        /* --- تنسيق Markdown --- */
        .bubble p { margin: 0 0 8px 0; }
        .bubble p:last-child { margin-bottom: 0; }
        .bubble ul, .bubble ol { margin: 8px 0; padding-right: 20px; }
        .bubble li { margin-bottom: 4px; }
        .bubble a { color: #007bff; text-decoration: underline; }
        .bubble strong, .bubble b { font-weight: bold; }
        .bubble em, .bubble i { font-style: italic; }
        .bubble code {
            font-family: 'monospace';
            background-color: rgba(0,0,0,0.05);
            padding: 2px 4px;
            border-radius: 4px;
        }
        .dark-mode .bubble code {
             background-color: rgba(255,255,255,0.1);
        }

        .status-message, .welcome-screen {
            text-align: center;
            padding: 60px 20px;
            color: var(--timestamp-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80%;
        }
        .welcome-screen img {
            width: 100px;
            height: 100px;
            margin-bottom: 24px;
            filter: var(--welcome-icon-filter);
        }
        .welcome-screen h2 {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-color);
            margin: 0 0 8px 0;
        }
        .welcome-screen p {
            font-size: 16px;
            color: var(--timestamp-color);
            margin: 0;
        }

        /* --- تنسيق المرفقات --- */
        .attachments-container {
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px; /* margin: const EdgeInsets.only(top: 6) */
            align-items: flex-end; /* لمحاذاة العناصر لليمين في حالة المستخدم */
        }
        
        .message.bot .attachments-container {
            align-items: flex-start;
        }

        .message-images {
            display: flex;
            flex-wrap: wrap;
            gap: 4px; /* مطابق للتطبيق */
            max-width: 250px; /* مطابق للتطبيق */
        }
        .message-images img {
            max-width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 16px; /* مطابق للتطبيق */
            border: 0.5px solid var(--attachment-border);
            cursor: default; /* تغيير المؤشر ليدل على عدم إمكانية النقر */
            pointer-events: none; /* منع أي تفاعل مع الصورة */
        }
        
        /* تخطيطات الصور المختلفة */
        .image-layout-1 img { width: 250px; height: 204px; }
        .image-layout-2 { display: flex; flex-direction: row; width: 250px; }
        .image-layout-2 img { flex: 1; height: 120px; }
        .image-layout-3 { display: flex; flex-direction: column; width: 250px; gap: 4px; }
        .image-layout-3 .row1 { display: flex; gap: 4px; }
        .image-layout-3 .row1 img { flex: 1; height: 100px; }
        .image-layout-3 .row2 img { width: 100%; height: 120px; }


        .file-attachment {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 12px;
            border: 0.5px solid var(--attachment-border);
            width: 220px; /* مطابق للتطبيق */
            box-sizing: border-box;
        }
        .file-attachment img {
            width: 40px; /* مطابق للتطبيق */
            height: 40px;
            margin-left: 8px;
            pointer-events: none; /* منع التفاعل مع الأيقونة */
        }
        .file-info {
            overflow: hidden;
            flex-grow: 1;
        }
        .file-info .name {
            font-size: 14px; /* bodyMedium */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-color);
        }
        .file-info .size {
            font-size: 11px;
            color: #65676b; /* grey.shade600 */
        }
        .dark-mode .file-info .size {
            color: #a0a0a0;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header"><h1 id="chat-title">Think AI</h1></div>
        <div class="chat-body" id="chat-body">
            <!-- المحتوى سيتم إضافته هنا بواسطة JavaScript -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // بيانات وهمية للمثال
            const conversation = {
                title: "محادثة تجريبية حول Flutter",
                messages: [
                    {
                        isUser: true,
                        text: "مرحباً، هل يمكنك تزويدي بمثال لعرض الصور والملفات في Flutter؟",
                        timestamp: "2025-09-23T10:00:00Z",
                        imageUrls: [],
                        attachedFiles: []
                    },
                    {
                        isUser: false,
                        text: "بالتأكيد! يمكنك استخدام `Image.file` للصور المحلية و `Image.network` للصور من الإنترنت. بالنسبة للملفات، يمكنك تصميم واجهة مخصصة لعرضها.",
                        timestamp: "2025-09-23T10:01:00Z",
                        imageUrls: [],
                        attachedFiles: []
                    },
                    {
                        isUser: true,
                        text: "ممتاز، لقد قمت بإرفاق بعض الأمثلة. هذه صورة لواجهة المستخدم، ملف PDF للمواصفات، وملف Word للتوثيق.",
                        timestamp: "2025-09-23T10:02:00Z",
                        imageUrls: ["https://via.placeholder.com/250x204.png/ECF2FE/000000?text=UI+Screenshot"],
                        attachedFiles: [
                            { name: "specs.pdf", size: "1.2 MB", type: "pdf" },
                            { name: "documentation.docx", size: "450 KB", type: "word" }
                        ]
                    },
                    {
                        isUser: false,
                        text: "رائع! التصميم يبدو نظيفًا. إليك مثال على كود برمجي لعرض قائمة:\n\n```dart\nListView.builder(\n  itemCount: items.length,\n  itemBuilder: (context, index) {\n    return ListTile(\n      title: Text(items[index]),\n    );\n  },\n);\n```",
                        timestamp: "2025-09-23T10:03:00Z",
                        imageUrls: [],
                        attachedFiles: []
                    },
                    {
                        isUser: true,
                        text: "شكرًا لك! سأجرب هذا الكود. أرفقت صورتين إضافيتين.",
                        timestamp: "2025-09-23T10:04:00Z",
                        imageUrls: ["https://via.placeholder.com/120x120.png/ECF2FE/000000?text=Img+1", "https://via.placeholder.com/120x120.png/ECF2FE/000000?text=Img+2"],
                        attachedFiles: []
                    },
                    {
                        isUser: true,
                        text: "", // رسالة فارغة مع مرفقات فقط
                        timestamp: "2025-09-23T10:05:00Z",
                        imageUrls: [],
                        attachedFiles: [
                            { name: "main.dart", size: "15 KB", type: "code" },
                            { name: "archive.zip", size: "2.5 MB", type: "zip" }
                        ]
                    }
                ]
            };

            const chatBody = document.getElementById('chat-body');
            const chatTitle = document.getElementById('chat-title');

            // التحقق من الوضع الليلي
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
            
            // الاستماع لتغيرات الوضع الليلي
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            });

            function getIconUrl(fileType) {
                const iconMap = {
                    'pdf': 'https://raw.githubusercontent.com/e-hr1/Think/main/assets/icon_file_pdf.png',
                    'word': 'https://raw.githubusercontent.com/e-hr1/Think/main/assets/icon_word.png',
                    'excel': 'https://raw.githubusercontent.com/e-hr1/Think/main/assets/icon_exel.png',
                    'pptx': 'https://raw.githubusercontent.com/e-hr1/Think/main/assets/icon_pptx.png',
                    'txt': 'https://raw.githubusercontent.com/e-hr1/Think/main/assets/icon_txt.png',
                    'code': 'https://raw.githubusercontent.com/e-hr1/Think/main/assets/icon_file_code.png'
                };
                // أيقونة افتراضية للملفات غير المعروفة
                return iconMap[fileType] || 'https://raw.githubusercontent.com/e-hr1/Think/main/assets/icon_file_code.png';
            }

            function displayConversation(conv) {
                chatTitle.textContent = conv.title || 'محادثة';
                chatBody.innerHTML = '';

                if (!conv.messages || conv.messages.length === 0) {
                    chatBody.innerHTML = `<div class="welcome-screen">...</div>`; // شاشة ترحيب
                    return;
                }

                conv.messages.forEach(msg => {
                    // تجاهل الرسائل الفارغة تمامًا
                    if (!msg.text && (!msg.imageUrls || msg.imageUrls.length === 0) && (!msg.attachedFiles || msg.attachedFiles.length === 0)) {
                        return;
                    }

                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${msg.isUser ? 'user' : 'bot'}`;

                    const wrapperEl = document.createElement('div');
                    wrapperEl.className = 'message-wrapper';

                    const attachmentsEl = document.createElement('div');
                    attachmentsEl.className = 'attachments-container';

                    // عرض الصور
                    if (msg.imageUrls && msg.imageUrls.length > 0) {
                        const imagesContainer = document.createElement('div');
                        const count = msg.imageUrls.length;
                        imagesContainer.className = `message-images image-layout-${count}`;
                        
                        if (count === 3) {
                            imagesContainer.innerHTML = `
                                <div class="row1">
                                    <img src="${msg.imageUrls[0]}" alt="صورة مرفقة 1">
                                    <img src="${msg.imageUrls[1]}" alt="صورة مرفقة 2">
                                </div>
                                <div class="row2">
                                    <img src="${msg.imageUrls[2]}" alt="صورة مرفقة 3">
                                </div>
                            `;
                        } else {
                            msg.imageUrls.forEach((url, index) => {
                                const img = document.createElement('img');
                                img.src = url;
                                img.alt = `صورة مرفقة ${index + 1}`;
                                imagesContainer.appendChild(img);
                            });
                        }
                        attachmentsEl.appendChild(imagesContainer);
                    }

                    // عرض الملفات
                    if (msg.attachedFiles && msg.attachedFiles.length > 0) {
                        msg.attachedFiles.forEach(file => {
                            const fileDiv = document.createElement('div');
                            fileDiv.className = 'file-attachment';
                            fileDiv.innerHTML = `
                                <img src="${getIconUrl(file.type)}" alt="${file.type} icon">
                                <div class="file-info">
                                    <div class="name">${file.name}</div>
                                    <div class="size">${file.size}</div>
                                </div>`;
                            attachmentsEl.appendChild(fileDiv);
                        });
                    }
                    
                    wrapperEl.appendChild(attachmentsEl);

                    // عرض النص
                    if (msg.text && msg.text.trim() !== '') {
                        const bubbleEl = document.createElement('div');
                        bubbleEl.className = 'bubble';
                        // استخدام مكتبة marked لتحويل النص
                        bubbleEl.innerHTML = marked.parse(msg.text);
                        wrapperEl.appendChild(bubbleEl);
                    }

                    messageEl.appendChild(wrapperEl);
                    chatBody.appendChild(messageEl);
                });
                
                // التمرير لأسفل لعرض آخر رسالة
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            // عرض المحادثة عند تحميل الصفحة
            displayConversation(conversation);
        });
    </script>
</body>
</html>
